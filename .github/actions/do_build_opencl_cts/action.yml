name: build opencl cts
description: build opencl cts

inputs:
  target:
    description: 'target architecture'

runs:
  # We don't want a new docker just a list of steps, so mark as composite
  using: "composite"
  steps:
    - name: calc vars
      id: calc_vars
      uses: ./.github/actions/calc_vars
      with:
        target: ${{ inputs.target }}

    - name: Install Ninja
      uses: llvm/actions/install-ninja@main
    
    - name: download icd artifact
      uses: actions/download-artifact@v4
      with:
        name: icd_${{inputs.target}}
        path: install_icd

    - name: download header artifact
      uses: actions/download-artifact@v4
      with:
        name: headers_install_${{inputs.target}}
        path: install_headers

    - name: build opencl cts
      shell: bash    
      run: |
        ls -l *
        git -c advice.detachedHead=false clone https://github.com/KhronosGroup/OpenCL-CTS --single-branch --depth 1
        cd OpenCL-CTS
        git log -1
        # Ignore patches for now
        #git apply $CI_PROJECT_DIR/patches/OpenCL-CTS-0001-Patch-sub-group-testing.patch
        #git apply $CI_PROJECT_DIR/patches/OpenCL-CTS-0002-Permit-building-for-unknown-architectures.patch
        # OpenCL CTS does not have an install target. Build directly in the install directory instead.
        # dummy artefact
        cd ..
        echo Hello > $GITHUB_WORKSPACE/opencl_cts_dir/artefact

    - name: upload opencl cts artifact
      uses: actions/upload-artifact@v4
      with:
        name: opencl_cts_${{inputs.target}}
        path: opencl_cts_dir
        retention-days: 1

